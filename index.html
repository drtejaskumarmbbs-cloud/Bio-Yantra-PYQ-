<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio Yantra PYQ - Pro Edition</title>
    <!-- CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-active:active { transform: scale(0.96); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 1.5rem; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .sidebar-anim { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { indigo: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' } } } }
        }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        window.FirebaseAPI = { 
            initializeApp, getAuth, GoogleAuthProvider, signInWithPopup, 
            onAuthStateChanged, signOut, getFirestore 
        };
    </script>

    <!-- Optional: external data.js -->
    <script src="data.js" onerror="console.warn('data.js not found, using internal fallbacks')"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Fallback Data if data.js fails to load in preview
        const FALLBACK_DATA = {
            LECTURES: { "The Living World": "JrnQ-91VIdo" },
            QUESTIONS: [
                { id: 1, classLevel: "11", chapter: "The Living World", year: 2023, question: "Correct hierarchical order?", options: ["K → P → C → O → F → G → S", "Other", "Other", "Other"], correctAnswer: 0, solution: "Sequence: Kingdom, Phylum, Class, Order, Family, Genus, Species." }
            ]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAt-vQ9broxgBbl0Wx_bxCy9AH8vdZiRE8",
            authDomain: "bio-yantra-pyq.firebaseapp.com",
            projectId: "bio-yantra-pyq",
            storageBucket: "bio-yantra-pyq.firebasestorage.app",
            messagingSenderId: "222151879306",
            appId: "1:222151879306:web:a0562af8ae4fcfc5255b73"
        };

        const CHAPTER_DATA = {
            "11": ["The Living World", "Biological Classification", "Plant Kingdom", "Animal Kingdom", "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals", "Cell: The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division", "Photosynthesis in Higher Plants", "Respiration in Plants", "Plant Growth and Development", "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination", "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"],
            "12": ["Sexual Reproduction in Flowering Plants", "Human Reproduction", "Reproductive Health", "Principles of Inheritance and Variation", "Molecular Basis of Inheritance", "Evolution", "Human Health and Disease", "Microbes in Human Welfare", "Biotechnology: Principles and Processes", "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation"]
        };

        const YEAR_RANGE = Array.from({ length: 16 }, (_, i) => 2010 + i);

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && name && iconRef.current) {
                    iconRef.current.innerHTML = `<i data-lucide="${name}" stroke-width="2.5" style="width:${size}px; height:${size}px;" class="${className}"></i>`;
                    window.lucide.createIcons();
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center"></span>;
        };

        const AuthWall = ({ onLogin }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50 dark:bg-slate-950 fade-in">
                <div className="w-full max-w-md p-8 bg-white dark:bg-slate-900 rounded-[3rem] shadow-2xl border dark:border-slate-800 text-center">
                    <div className="inline-flex p-5 bg-indigo-100 dark:bg-indigo-900/30 rounded-3xl mb-6 text-indigo-600"><Icon name="zap" size={48} /></div>
                    <h1 className="text-4xl font-black dark:text-white mb-2">BIO <span className="text-indigo-500">YANTRA</span></h1>
                    <p className="text-slate-500 dark:text-slate-400 mb-10 font-bold">Sign in to unlock PYQs</p>
                    <button onClick={onLogin} className="w-full h-16 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl flex items-center justify-center gap-4 text-lg font-black dark:text-slate-100 shadow-lg btn-active transition-all">
                        <svg className="w-6 h-6" viewBox="0 0 48 48">
                            <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
                            <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
                            <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
                            <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
                        </svg>
                        Continue with Google
                    </button>
                </div>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('home');
            const [darkMode, setDarkMode] = useState(true);
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [resourceFilter, setResourceFilter] = useState("all");
            const [filters, setFilters] = useState({ classLevel: "All", chapter: "All Chapters", startYear: 2010, endYear: 2025 });
            const [session, setSession] = useState({ questions: [], currentIndex: 0, userAnswers: {}, startTime: null });
            
            const authRef = useRef(null);

            // Initialize Firebase with protection against infinite loading
            useEffect(() => {
                let attempts = 0;
                const checkFirebase = setInterval(() => {
                    attempts++;
                    if (window.FirebaseAPI) {
                        const { initializeApp, getAuth, onAuthStateChanged } = window.FirebaseAPI;
                        const app = initializeApp(firebaseConfig);
                        authRef.current = getAuth(app);
                        onAuthStateChanged(authRef.current, (u) => {
                            setUser(u);
                            setLoading(false);
                        });
                        clearInterval(checkFirebase);
                    } else if (attempts > 50) { // Fallback if Firebase fails to load (5 seconds)
                        setLoading(false);
                        clearInterval(checkFirebase);
                        console.error("Firebase failed to load in time.");
                    }
                }, 100);
                return () => clearInterval(checkFirebase);
            }, []);

            const handleLogin = async () => {
                if(!window.FirebaseAPI) return alert("Auth not ready. Please refresh.");
                const { GoogleAuthProvider, signInWithPopup } = window.FirebaseAPI;
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(authRef.current, provider); } catch (err) { console.error(err); }
            };

            const handleLogout = () => { window.FirebaseAPI.signOut(authRef.current); setSidebarOpen(false); };

            const navigate = (v) => { window.history.pushState({ view: v }, ''); setView(v); };

            const availableChapters = useMemo(() => {
                if (filters.classLevel === "11") return ["All Chapters", ...CHAPTER_DATA["11"]];
                if (filters.classLevel === "12") return ["All Chapters", ...CHAPTER_DATA["12"]];
                return ["All Chapters", ...CHAPTER_DATA["11"], ...CHAPTER_DATA["12"]];
            }, [filters.classLevel]);

            const startPractice = () => {
                const questions = window.ALL_QUESTIONS || FALLBACK_DATA.QUESTIONS;
                const filtered = questions.filter(q => {
                    const matchesClass = filters.classLevel === "All" || q.classLevel === filters.classLevel;
                    const matchesChapter = filters.chapter === "All Chapters" || q.chapter === filters.chapter;
                    const matchesYear = q.year >= filters.startYear && q.year <= filters.endYear;
                    return matchesClass && matchesChapter && matchesYear;
                });
                if (filtered.length === 0) return alert("No questions found!");
                setSession({ questions: filtered, currentIndex: 0, userAnswers: {}, startTime: Date.now() });
                navigate('practice');
            };

            // Smart Viewer (Improved for reliability)
            const SmartViewer = ({ res, onClose, type }) => {
                const [innerLoading, setInnerLoading] = useState(true);
                // Fix for YouTube and PDF embedding
                const viewerUrl = type === 'lecture' 
                    ? `https://www.youtube-nocookie.com/embed/${res.link}?autoplay=1&rel=0` 
                    : `https://docs.google.com/viewer?url=${encodeURIComponent(res.link)}&embedded=true`;

                return (
                    <div className="fixed inset-0 z-[250] bg-slate-950 flex flex-col fade-in">
                        <div className="h-16 px-4 flex items-center justify-between bg-slate-900 border-b border-white/5 text-white">
                            <button onClick={onClose} className="p-2 bg-white/5 rounded-xl"><Icon name="arrow-left"/></button>
                            <h3 className="text-xs font-black truncate max-w-[200px] uppercase">{res.name}</h3>
                            <button onClick={() => window.open(res.link, '_blank')} className="p-2 bg-white/5 rounded-xl"><Icon name="external-link" size={18}/></button>
                        </div>
                        <div className="flex-1 relative bg-slate-900 flex flex-col items-center justify-center p-2">
                            {innerLoading && <div className="absolute inset-0 flex flex-col items-center justify-center z-20 bg-slate-900"><div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div></div>}
                            <iframe src={viewerUrl} className="w-full h-full max-w-5xl rounded-3xl shadow-2xl" onLoad={() => setInnerLoading(false)} allowFullScreen></iframe>
                        </div>
                    </div>
                );
            };

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-950">
                    <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-6"></div>
                    <p className="text-indigo-400 font-black text-xs tracking-[0.3em] animate-pulse uppercase">Syncing Bio Yantra...</p>
                </div>
            );

            if (!user) return <AuthWall onLogin={handleLogin} />;

            // Views: Home, Practice, Performance, etc.
            return (
                <div className="min-h-screen text-slate-900 dark:text-slate-100">
                    {/* Sidebar Placeholder */}
                    <div className={`fixed inset-0 z-[200] ${isSidebarOpen ? 'visible' : 'invisible'}`}>
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setSidebarOpen(false)}></div>
                        <div className={`fixed left-0 top-0 w-72 h-full bg-slate-900 shadow-2xl sidebar-anim flex flex-col ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="p-8 border-b border-white/5 flex items-center gap-4">
                                <img src={user.photoURL} className="w-12 h-12 rounded-2xl border-2 border-indigo-500" />
                                <div className="min-w-0"><p className="font-black text-xs text-white truncate">{user.displayName}</p><p className="text-[10px] text-slate-500 truncate">{user.email}</p></div>
                            </div>
                            <div className="flex-1 p-4 space-y-2">
                                <button onClick={() => {navigate('home'); setSidebarOpen(false);}} className="w-full flex items-center gap-4 px-4 py-3 rounded-2xl hover:bg-white/5 font-bold text-slate-400"><Icon name="home"/> Home</button>
                                <button onClick={() => {navigate('performance'); setSidebarOpen(false);}} className="w-full flex items-center gap-4 px-4 py-3 rounded-2xl hover:bg-white/5 font-bold text-slate-400"><Icon name="bar-chart-3"/> Performance</button>
                                <button onClick={handleLogout} className="w-full flex items-center gap-4 px-4 py-3 rounded-2xl hover:bg-red-500/10 text-red-400 font-bold mt-10"><Icon name="log-out"/> Logout</button>
                            </div>
                        </div>
                    </div>

                    {view === 'home' && (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4 fade-in">
                            <button onClick={() => setSidebarOpen(true)} className="fixed top-6 left-6 p-3 bg-slate-900 rounded-2xl shadow-xl border border-white/5"><Icon name="menu"/></button>
                            <div className="w-full max-w-md bg-slate-900 rounded-[3.5rem] p-10 border border-white/5 shadow-2xl">
                                <div className="text-center mb-10">
                                    <div className="inline-flex p-4 bg-indigo-500/10 rounded-3xl mb-4 text-indigo-500"><Icon name="dna" size={42} /></div>
                                    <h1 className="text-3xl font-black text-white tracking-tighter">Bio <span className="text-indigo-500">Yantra PYQ</span></h1>
                                </div>
                                <div className="space-y-6">
                                    <div className="grid grid-cols-3 gap-2">{["All", "11", "12"].map(l => <button key={l} onClick={() => setFilters({...filters, classLevel: l, chapter: "All Chapters"})} className={`h-11 rounded-xl font-bold border transition-all ${filters.classLevel === l ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-slate-800 border-white/5 text-slate-400'}`}>{l === "All" ? "Both" : `Class ${l}`}</button>)}</div>
                                    <select value={filters.chapter} onChange={e => setFilters({...filters, chapter: e.target.value})} className="w-full h-12 bg-slate-800 rounded-xl px-4 font-bold text-white border border-white/5 outline-none">{availableChapters.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                    <button onClick={startPractice} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-indigo-500/20 active:scale-95 transition-all uppercase">Start Practice</button>
                                    <div className="grid grid-cols-3 gap-2 pt-4 border-t border-white/5">
                                        <button onClick={() => navigate('lecture')} className="py-3 rounded-2xl bg-slate-800/50 text-indigo-400 flex flex-col items-center gap-1 active:scale-95"><Icon name="video" size={18}/> <span className="text-[8px] font-black uppercase">Lec</span></button>
                                        <button onClick={() => navigate('notes')} className="py-3 rounded-2xl bg-slate-800/50 text-purple-400 flex flex-col items-center gap-1 active:scale-95"><Icon name="file-text" size={18}/> <span className="text-[8px] font-black uppercase">Notes</span></button>
                                        <button onClick={() => navigate('mindmap')} className="py-3 rounded-2xl bg-slate-800/50 text-pink-400 flex flex-col items-center gap-1 active:scale-95"><Icon name="brain" size={18}/> <span className="text-[8px] font-black uppercase">Maps</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Practice and Analysis Views logic here (similar to previous version but sanitized) */}
                    {view === 'practice' && (
                        <div className="min-h-screen flex flex-col bg-slate-950">
                            <div className="h-16 px-6 bg-slate-900 border-b border-white/5 flex items-center justify-between">
                                <button onClick={() => navigate('home')} className="text-slate-400"><Icon name="arrow-left"/></button>
                                <p className="text-xs font-black uppercase tracking-widest text-indigo-400">Question Portal</p>
                                <div className="w-8"></div>
                            </div>
                            <div className="flex-1 flex items-center justify-center p-6 text-center">
                                <div className="p-10 bg-slate-900 rounded-[3rem] border border-white/5">
                                    <Icon name="terminal" size={64} className="mx-auto mb-4 text-slate-700"/>
                                    <h2 className="text-xl font-bold">Simulator Active</h2>
                                    <p className="text-slate-500 text-sm mt-2">Question data is streaming from <code>data.js</code></p>
                                    <button onClick={() => navigate('home')} className="mt-8 px-8 py-3 bg-indigo-600 rounded-xl font-black text-xs">EXIT SIMULATOR</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {(view === 'lecture' || view === 'notes' || view === 'mindmap') && (
                        <div className="min-h-screen bg-slate-950 fade-in">
                            <div className="h-16 px-6 bg-slate-900 border-b border-white/5 flex items-center gap-4">
                                <button onClick={() => navigate('home')} className="text-slate-400"><Icon name="arrow-left"/></button>
                                <h3 className="font-black uppercase text-xs tracking-widest">{view} Content</h3>
                            </div>
                            <div className="p-6 space-y-4">
                                {Object.keys(window.LECTURES_LINKS || FALLBACK_DATA.LECTURES).map(ch => (
                                    <div key={ch} className="p-5 bg-slate-900 rounded-3xl border border-white/5 flex items-center justify-between">
                                        <div className="min-w-0 pr-4"><p className="font-bold text-sm truncate">{ch}</p></div>
                                        <button onClick={() => navigate('home')} className="p-3 bg-indigo-600 rounded-xl"><Icon name="play" size={16}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

